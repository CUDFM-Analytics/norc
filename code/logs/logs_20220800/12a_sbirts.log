2322  /*
2323  PROGRAM:
2324  PURPOSE:        NORC upload
2325  PROGRAMMER:     K Wiggins
2326  DATE:           08/28/2022
2327  PROCESS:        Sabrina Lor exports REDCap, Qualtrics to S:drive>data_team as <file>_raw_;
2328  NOTES:          - if task_id in (193, 201) and Finished = 1 / Keep_or_delete = keep ;
2329                  - sbirt is qualtrics export - start on row 3
2330                  - template requires 55 columns;
2331  ---------------------------------------------------------------------------------------------
2331! --------
2332  CHANGE LOG
2333   Date    By  Purpose
2334  1. 01/15/22  KW  Copied from Dionisia's original to not mess with it
2335  2. 08/28/22  KW  adapted for august upload; 88
2336
2337  LAST RAN: 08/25/2022
2338  */
2339
2340  * Set global variables and function calls;
2341  * ROOT FOLDER  ---------------------------------------;
2342  %let root = S:/FM/FM/Data_Management_Team;
2343  * INCLUDE --------------------------------------------;
2344  %include "&root/norc/code_folder/00_paths_lets.sas";
SYMBOLGEN:  Macro variable ROOT resolves to S:/FM/FM/Data_Management_Team
SYMBOLGEN:  Macro variable ROOT resolves to S:/FM/FM/Data_Management_Team
SYMBOLGEN:  Macro variable ROOT resolves to S:/FM/FM/Data_Management_Team
SYMBOLGEN:  Macro variable ROOT resolves to S:/FM/FM/Data_Management_Team
SYMBOLGEN:  Macro variable ROOT resolves to S:/FM/FM/Data_Management_Team
SYMBOLGEN:  Macro variable ROOT resolves to S:/FM/FM/Data_Management_Team
SYMBOLGEN:  Macro variable FORM resolves to S:/FM/FM/Data_Management_Team/norc/background
SYMBOLGEN:  Macro variable FORM resolves to S:/FM/FM/Data_Management_Team/norc/background
SYMBOLGEN:  Macro variable SURVTEMPLATE resolves to
            S:/FM/FM/Data_Management_Team/norc/background/survey_template_order.xlsx
SYMBOLGEN:  Macro variable DATA resolves to S:/FM/FM/Data_Management_Team/raw data
SYMBOLGEN:  Macro variable DATA resolves to S:/FM/FM/Data_Management_Team/raw data
SYMBOLGEN:  Macro variable DATA resolves to S:/FM/FM/Data_Management_Team/raw data
SYMBOLGEN:  Macro variable DATA resolves to S:/FM/FM/Data_Management_Team/raw data
SYMBOLGEN:  Macro variable DATA resolves to S:/FM/FM/Data_Management_Team/raw data
SYMBOLGEN:  Macro variable DATA resolves to S:/FM/FM/Data_Management_Team/raw data
SYMBOLGEN:  Macro variable DATA resolves to S:/FM/FM/Data_Management_Team/raw data
SYMBOLGEN:  Macro variable ONEDRIVE resolves to C:/Users/wigginki/OneDrive - The University of
            Colorado Denver/Documents/projects
NOTE: Format PCTFMT is already on the library WORK.FORMATS.
NOTE: Format PCTFMT has been output.

NOTE: PROCEDURE FORMAT used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds


NOTE: Writing HTML Body file: sashtml5.htm
WARNING: Could not restore referenced object: Base.Freq.CellChiSquare.
WARNING: Could not find parent template: Base.Freq.CellChiSquare.
WARNING: Could not restore referenced object: Base.Freq.PearsonResidual.
WARNING: Could not find parent template: Base.Freq.PearsonResidual.
WARNING: Could not restore referenced object: Base.Freq.Deviation.
WARNING: Could not find parent template: Base.Freq.Deviation.
WARNING: Could not restore referenced object: Base.Freq.Expected.
WARNING: Could not find parent template: Base.Freq.Expected.
NOTE: Overwriting existing template/link: Base.Freq.OneWayList
NOTE: TABLE 'Base.Freq.OneWayList' has been saved to: SASUSER.TEMPLAT
NOTE: PROCEDURE TEMPLATE used (Total process time):
      real time           0.29 seconds
      cpu time            0.14 seconds



NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds


SYMBOLGEN:  Macro variable DATESTAMP resolves to 20220828
20220828
SYMBOLGEN:  Macro variable NORC resolves to S:/FM/FM/Data_Management_Team/norc/results
NOTE: Libref NORC was successfully assigned as follows:
      Engine:        V9
      Physical Name: S:\FM\FM\Data_Management_Team\norc\results
NOTE: Format MISSING is already on the library NORC.FORMATS.
NOTE: Format MISSING has been written to NORC.FORMATS.

NOTE: PROCEDURE FORMAT used (Total process time):
      real time           0.10 seconds
      cpu time            0.03 seconds


2420     *has paths and all let statements for project;
2421
2422  proc import
2423      file = "&sbirt."
SYMBOLGEN:  Macro variable SBIRT resolves to S:/FM/FM/Data_Management_Team/raw
            data/FASTSBIRT_raw_08222022.xlsx
2424      out = sbirt0
2425      dbms = xlsx replace;
2426      datarow = 3;
2427  run;

NOTE:    Variable Name Change.  Duration (in seconds) -> Duration__in_seconds_
NOTE:    Variable Name Change.  RE1_First Click -> RE1_First_Click
NOTE:    Variable Name Change.  RE1_Last Click -> RE1_Last_Click
NOTE:    Variable Name Change.  RE1_Page Submit -> RE1_Page_Submit
NOTE:    Variable Name Change.  RE1_Click Count -> RE1_Click_Count
NOTE:    Variable Name Change.  RE5_Operating System -> RE5_Operating_System
NOTE:    Variable Name Change.  screentools_-66 -> screentools__66
NOTE:    Variable Name Change.  screentools_-66_TEXT -> screentools__66_TEXT
NOTE:    Variable Name Change.  patient_type_-66 -> patient_type__66
NOTE:    Variable Name Change.  patient_type_-66_TEXT -> patient_type__66_TEXT
NOTE:    Variable Name Change.  workflow_person_-66 -> workflow_person__66
NOTE:    Variable Name Change.  workflow_person_-66_TEXT -> workflow_person__66_TEXT
NOTE:    Variable Name Change.  tools_-66 -> tools__66
NOTE:    Variable Name Change.  tools_-66_TEXT -> tools__66_TEXT
NOTE:    Variable Name Change.  interpret_-66 -> interpret__66
NOTE:    Variable Name Change.  interpret_-66_TEXT -> interpret__66_TEXT
NOTE:    Variable Name Change.  further_assess_-66 -> further_assess__66
NOTE:    Variable Name Change.  further_assess_-66_TEXT -> further_assess__66_TEXT
NOTE:    Variable Name Change.  support_-66 -> support__66
NOTE:    Variable Name Change.  support_-66_TEXT -> support__66_TEXT
NOTE:    Variable Name Change.  Q22_First Click -> Q22_First_Click
NOTE:    Variable Name Change.  Q22_Last Click -> Q22_Last_Click
NOTE:    Variable Name Change.  Q22_Page Submit -> Q22_Page_Submit
NOTE:    Variable Name Change.  Q22_Click Count -> Q22_Click_Count
NOTE:    Variable Name Change.  RE3_First Click -> RE3_First_Click
NOTE:    Variable Name Change.  RE3_Last Click -> RE3_Last_Click
NOTE:    Variable Name Change.  RE3_Page Submit -> RE3_Page_Submit
NOTE:    Variable Name Change.  RE3_Click Count -> RE3_Click_Count
NOTE:    Variable Name Change.  KEEP OR DELETE -> KEEP_OR_DELETE
NOTE: One or more variables were converted because the data type is not supported by the V9
      engine. For more details, run with options MSGLEVEL=I.
NOTE: The import data set has 99 observations and 109 variables.
NOTE: WORK.SBIRT0 data set was successfully created.
NOTE: PROCEDURE IMPORT used (Total process time):
      real time           0.28 seconds
      cpu time            0.06 seconds


2427!      *99, 109;
2428
2429  data sbirt1;
2430  set  sbirt0;
2431  where keep_or_delete = "KEEP"
2432  AND
2433  task_id in ('193', '201');
2434  GRANTEE = 'CO';
2435  run;

NOTE: There were 88 observations read from the data set WORK.SBIRT0.
      WHERE (keep_or_delete='KEEP') and task_id in ('193', '201');
NOTE: The data set WORK.SBIRT1 has 88 observations and 110 variables.
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds


2435!      *88, 110 - dropped 6 entries from keep/delete;
2436
2437  proc freq data = sbirt1;
2438  tables finished task_id sim_id;
2439  run;

WARNING: Could not restore referenced object: Base.Freq.Expected.
WARNING: Could not find parent template: Base.Freq.Expected.
WARNING: Could not restore referenced object: Base.Freq.Deviation.
WARNING: Could not find parent template: Base.Freq.Deviation.
WARNING: Could not restore referenced object: Base.Freq.PearsonResidual.
WARNING: Could not find parent template: Base.Freq.PearsonResidual.
WARNING: Could not restore referenced object: Base.Freq.CellChiSquare.
WARNING: Could not find parent template: Base.Freq.CellChiSquare.
NOTE: There were 88 observations read from the data set WORK.SBIRT1.
NOTE: PROCEDURE FREQ used (Total process time):
      real time           0.03 seconds
      cpu time            0.00 seconds


2439!      *finished n=88 all value of 1 / task_id 193 n=51, 201 n=37;
2440  *sim_id all 1 or 2;
2441
2442  proc sql;
2443  create table sbirt2 as
2444  select GRANTEE
2445          , task_id
2446          , sim_id         as PRACTICE_ID
2447          , AUD_pts_screen as SCREENING_PROCESS
2448          , screentools_1  as TOOL_SASQ
2449          , screentools_2  as TOOL_AUDIT3
2450          , screentools_3  as TOOL_AUDIT10
2451          , screentools__66_TEXT as TOOL_OTHER
2452          , patient_type_1 as SCREEN_18ABOVE
2453          , patient_type_2 as SCREEN_AGERANGE
2454          , patient_type_2_TEXT as SCREEN_AGERANGE_OPENEND
2455          , patient_type_3 as SCREEN_CONDITION
2456          , patient_type_3_TEXT as SCREEN_CONDITION_OPENEND
2457          , patient_type_4 as SCREEN_MAINTENANCE_PREVENTIVE
2458          , patient_type_5 as SCREEN_TELEHEALTH
2459          , patient_type_6 as SCREEN_WEB
2460          , patient_type__66_TEXT as SCREEN_OTHER
2461          , Frequency         as SCREENED_FREQUENCY
2462          , workflow_person_1 as INVOLVED_SELFADMINISTERED
2463          , workflow_person_2 as INVOLVED_CLINICIAN
2464          , workflow_person_3 as INVOLVED_BH
2465          , workflow_person_4 as INVOLVED_OTHERCLINICAL
2466          , workflow_person_5 as INVOLVED_OFFICEMANAGER
2467          , workflow_person_6 as INVOLVED_FRONTBACKSTAFF
2468          , workflow_person_7 as INVOLVED_PEERPROVIDER
2469          , workflow_person_8 as INVOLVED_PHARMACIST
2470          , workflow_person__66_TEXT as INVOLVED_OTHER
2471          , tools_1 as DOCUMENTATIONTOOL_NONE
2472          , tools_2 as DOCUMENTATIONTOOL_PAPERSCREEN
2473          , tools_3 as DOCUMENTATIONTOOL_PAPERHR
2474          , tools_4 as DOCUMENTATIONTOOL_EHRUNS /*change in excel after final export*/
2475          , tools_5 as DOCUMENTATIONTOOL_EHRST/*change in excel after final export*/
2476          , tools__66_TEXT as DOCUMENTATIONTOOL_OTHER
2477          , review_rslts as SCREENING_REVIEW_PROCESS_GENERAL
2478          , interpret_1 as REVIEWPROCESS_FLAGBI
2479          , interpret_2 as REVIEWPROCESS_COUNSELBI
2480          , interpret_3 as REVIEWPROCESS_NEEDBI
2481          , interpret_4 as REVIEWPROCESS_IDENTIFYAUDSX
2482          , interpret_5 as REVIEWPROCESS_PROMPTAUD
2483          , interpret__66_TEXT as REVIEWPROCESS_OTHER
2484          , positive_AUD as POSITIVE_INDIV/*change in excel after final export*/
2485          , further_assess_1 as POSITIVETOOL_DSM
2486          , further_assess_2 as POSITIVETOOL_AUDIT
2487          , further_assess_3 as POSITIVETOOL_CAGE
2488          , further_assess__66_TEXT as POSITIVETOOL_OTHER
2489          , feedback as SCREENING_RESULTS_FEEDBACK
2490          , care_AUD as PRACTICE_SUPPORT
2491          , support_1 as SUPPORT_BICLINICIAN
2492          , support_2 as SUPPORT_BIBH
2493          , support_3 as SUPPORT_EDUCATION
2494          , support_4 as SUPPORT_REFEREXTERNAL
2495          , support_5 as SUPPORT_REFERPEER
2496          , support_6 as SUPPORT_TREATMENT
2497          , support_7 as SUPPORT_RX
2498          , support_8 as SUPPORT_MAT
2499          , support__66_TEXT as SUPPORT_OTHER
2500  from sbirt1;
NOTE: Table WORK.SBIRT2 created, with 88 rows and 56 columns.

2501  quit;
NOTE: PROCEDURE SQL used (Total process time):
      real time           0.05 seconds
      cpu time            0.03 seconds


2501!       *88, 56 - will drop task_id later  ;
2502
2503  * Get order of variables for upload;
2504
2505  * Have to change template names bc > 32 bytes;
2506  data norc.template_sbirt (keep=template field extract_comments);
2507  set  norc.templates;
2508  Field = tranwrd(Field, 'DOCUMENTATIONTOOL_EHRUNSTRUCTURED', 'DOCUMENTATIONTOOL_EHRUNS');
2509  Field = tranwrd(Field, 'DOCUMENTATIONTOOL_EHRSTANDARDIZED', 'DOCUMENTATIONTOOL_EHRST');
2510  Field = tranwrd(Field, 'POSITIVE_INDIVIDUAL_PROCESS_GENERAL', 'POSITIVE_INDIV');
2511  where template contains 'SBI_RT';
2512  run;

NOTE: There were 110 observations read from the data set NORC.TEMPLATES.
      WHERE template contains 'SBI_RT';
NOTE: The data set NORC.TEMPLATE_SBIRT has 110 observations and 3 variables.
NOTE: DATA statement used (Total process time):
      real time           0.44 seconds
      cpu time            0.06 seconds


2512!      *110, 3;
2513
2514  * Create macro with list of names in order;
2515  proc sql noprint;
2516  select Field
2517  into :order separated by ' '
2518  from norc.template_sbirt;
2519  quit;
NOTE: PROCEDURE SQL used (Total process time):
      real time           0.09 seconds
      cpu time            0.00 seconds


2520
2521  * re-order most recent iteration of work.sbirtX to match macro using retain;
2522  data sbirt3;
SYMBOLGEN:  Macro variable ORDER resolves to GRANTEE PRACTICE_ID SCREENING_PROCESS TOOL_SASQ
            TOOL_AUDIT3 TOOL_AUDIT10 TOOL_OTHER SCREEN_18ABOVE SCREEN_AGERANGE
            SCREEN_AGERANGE_OPENEND SCREEN_CONDITION SCREEN_CONDITION_OPENEND
            SCREEN_MAINTENANCE_PREVENTIVE SCREEN_TELEHEALTH SCREEN_WEB SCREEN_OTHER
            SCREENED_FREQUENCY INVOLVED_SELFADMINISTERED INVOLVED_CLINICIAN INVOLVED_BH
            INVOLVED_OTHERCLINICAL INVOLVED_OFFICEMANAGER INVOLVED_FRONTBACKSTAFF
            INVOLVED_PEERPROVIDER INVOLVED_PHARMACIST INVOLVED_OTHER DOCUMENTATIONTOOL_NONE
            DOCUMENTATIONTOOL_PAPERSCREEN DOCUMENTATIONTOOL_PAPERHR DOCUMENTATIONTOOL_EHRUNS
            DOCUMENTATIONTOOL_EHRST DOCUMENTATIONTOOL_OTHER SCREENING_REVIEW_PROCESS_GENERAL
            REVIEWPROCESS_FLAGBI REVIEWPROCESS_COUNSELBI REVIEWPROCESS_NEEDBI
            REVIEWPROCESS_IDENTIFYAUDSX REVIEWPROCESS_PROMPTAUD REVIEWPROCESS_OTHER POSITIVE_INDIV
            POSITIVETOOL_DSM POSITIVETOOL_AUDIT POSITIVETOOL_CAGE POSITIVETOOL_OTHER
            SCREENING_RESULTS_FEEDBACK PRACTICE_SUPPORT SUPPORT_BICLINICIAN SUPPORT_BIBH
            SUPPORT_EDUCATION SUPPORT_REFEREXTERNAL SUPPORT_REFERPEER SUPPORT_TREATMENT SUPPORT_RX
            SUPPORT_MAT SUPPORT_OTHER GRANTEE PRACTICE_ID SCREENING_PROCESS TOOL_SASQ TOOL_AUDIT3
            TOOL_AUDIT10 TOOL_Other SCREEN_18ABOVE SCREEN_AGERANGE SCREEN_AGERANGE_OPENEND
            SCREEN_CONDITION SCREEN_CONDITION_OPENEND SCREEN_MAINTENANCE_PREVENTIVE
            SCREEN_TELEHEALTH SCREEN_WEB SCREEN_OTHER SCREENED_FREQUENCY INVOLVED_SELFADMINISTERED
            INVOLVED_CLINICIAN INVOLVED_BH INVOLVED_OTHERCLINICAL INVOLVED_OFFICEMANAGER
            INVOLVED_FRONTBACKSTAFF INVOLVED_PEERPROVIDER INVOLVED_PHARMACIST INVOLVED_OTHER
            DOCUMENTATIONTOOL_NONE DOCUMENTATIONTOOL_PAPERSCREEN DOCUMENTATIONTOOL_PAPERHR
            DOCUMENTATIONTOOL_EHRUNS DOCUMENTATIONTOOL_EHRST DOCUMENTATIONTOOL_OTHER
            SCREENING_REVIEW_PROCESS_GENERAL REVIEWPROCESS_FLAGBI REVIEWPROCESS_COUNSELBI
            REVIEWPROCESS_NEEDBI REVIEWPROCESS_IDENTIFYAUDSX REVIEWPROCESS_PROMPTAUD
            REVIEWPROCESS_OTHER POSITIVE_INDIV POSITIVETOOL_DSM POSITIVETOOL_AUDIT
            POSITIVETOOL_CAGE POSITIVETOOL_OTHER SCREENING_RESULTS_FEEDBACK PRACTICE_SUPPORT
            SUPPORT_BICLINICIAN SUPPORT_BIBH SUPPORT_EDUCATION SUPPORT_REFEREXTERNAL
            SUPPORT_REFERPEER SUPPORT_TREATMENT SUPPORT_RX SUPPORT_MAT SUPPORT_OTHER
2523  retain &order.;
2524  set  sbirt2;
2525  run;

NOTE: There were 88 observations read from the data set WORK.SBIRT2.
NOTE: The data set WORK.SBIRT3 has 88 observations and 56 variables.
NOTE: DATA statement used (Total process time):
      real time           0.03 seconds
      cpu time            0.03 seconds


2526
2527  proc freq data = sbirt3;
2528  tables _all_*task_id;
2529  run;

NOTE: There were 88 observations read from the data set WORK.SBIRT3.
NOTE: PROCEDURE FREQ used (Total process time):
      real time           0.24 seconds
      cpu time            0.18 seconds


2530
2531  * Split file by task_id and drop column, save to library 'norc';
2532  data norc.sbirt_baseline (drop=task_id) norc.sbirt_post (drop=task_id);
2533  set sbirt3;
2534  if task_id = 193 then output norc.sbirt_baseline;
2535  if task_id = 201 then output norc.sbirt_post;
2536  run;

NOTE: Character values have been converted to numeric values at the places given by:
      (Line):(Column).
      2534:4   2535:4
NOTE: There were 88 observations read from the data set WORK.SBIRT3.
NOTE: The data set NORC.SBIRT_BASELINE has 51 observations and 55 variables.
NOTE: The data set NORC.SBIRT_POST has 37 observations and 55 variables.
NOTE: DATA statement used (Total process time):
      real time           0.61 seconds
      cpu time            0.04 seconds


2536!      *51,55 / 37,55;
2537
2538  * Export files;
2539  proc export data = norc.sbirt_baseline
2540    outfile = "&norc/sbirt_baseline_&datestamp"
SYMBOLGEN:  Macro variable NORC resolves to S:/FM/FM/Data_Management_Team/norc/results
SYMBOLGEN:  Macro variable DATESTAMP resolves to 20220828
2541    dbms=xlsx replace;
2542  run;

NOTE: The export data set has 51 observations and 55 variables.
NOTE: "S:\FM\FM\Data_Management_Team\norc\results\sbirt_baseline_20220828.xlsx" file was
      successfully created.
NOTE: PROCEDURE EXPORT used (Total process time):
      real time           0.65 seconds
      cpu time            0.06 seconds


2543
2544  proc export data = norc.sbirt_post
2545    outfile = "&norc/sbirt_post_&datestamp"
SYMBOLGEN:  Macro variable NORC resolves to S:/FM/FM/Data_Management_Team/norc/results
SYMBOLGEN:  Macro variable DATESTAMP resolves to 20220828
2546    dbms=xlsx replace;
2547  run;

NOTE: The export data set has 37 observations and 55 variables.
NOTE: "S:\FM\FM\Data_Management_Team\norc\results\sbirt_post_20220828.xlsx" file was successfully
      created.
NOTE: PROCEDURE EXPORT used (Total process time):
      real time           0.72 seconds
      cpu time            0.09 seconds


2548
2549
2550  * delete BAK files created by PROC EXPORT;
2551  filename bak  "&norc/sbirt_post_20220828.xlsx.bak";
SYMBOLGEN:  Macro variable NORC resolves to S:/FM/FM/Data_Management_Team/norc/results
2552  filename bak2 "&norc/sbirt_baseline_20220828.xlsx.bak";
SYMBOLGEN:  Macro variable NORC resolves to S:/FM/FM/Data_Management_Team/norc/results
2553
2554  data _null_;
2555   rc = fdelete("bak");
2556   rc = fdelete("bak2");
2557  run;

NOTE: DATA statement used (Total process time):
      real time           0.06 seconds
      cpu time            0.03 seconds


2558
2559  filename bak clear;
NOTE: Fileref BAK has been deassigned.
2560  filename bak2 clear;
NOTE: Fileref BAK2 has been deassigned.

